# 이벤트 루프와 비동기 통신의 이해

자바스크립트는 싱글 스레드에서 작동
⇒ 한 번에 하나의 작업만 동기적으로 처리 가능

# 싱글 스레드 자바스크립트

## 프로세스란

프로그램을 구동해 프로그램의 상태가 메모리상에서 실행되는 작업 단위

- 하나의 프로그램은 하나의 프로세스 가짐
- 프로세스 내부에서 모든 작업 처리

그러나 하나의 프로그램에서 하나의 프로세스만 동작하면 여러 복잡한 작업들 처리에 어려움 발생

## 스레드의 등장

프로세스보다 더 작은 실행 단위로, 하나의 프로세스에서는 여러 개의 스레드가 동작

- 스레드 간 메모리 공유 가능 → 여러 작업 동시 수행

## 왜 싱글 스레드인가

### 멀티 스레드의 단점

- 내부적으로 처리가 복잡
- 동시에 여러 작업을 수행하다 보면 같은 자원에 대한 여러 번의 수정과 같은 겨우 발생 → 동시성 문제
- 하나의 스레드에 문제가 생기면 자원을 공유하는 다른 스레드에도 문제 발생

### 초창기 자바스크립트

- HTML에 대해 보조적인 역할
- alert 창 띄우기, form 전송 등의 간단한 작업 처리 용도

⇒ 현재의 자바스크립트처럼 복잡한 동작들을 수행할 지 몰랐음

또한 DOM 요소를 여러 스레드가 조작하게 되면 타이밍 문제 발생 가능

### 싱글 스레드 자바스크립트

- 자바스크립트 코드의 수행이 하나의 스레드에서 순차적으로 발생
- 하나의 코드 실행이 오래 걸리면 뒤이은 코드는 실행 안 됨 → Run-to-completion

### 자바스크립트에서 비동기 처리

비동기 함수를 `async` 키워드를 통해 선언
⇒ 즉시 결과가 주어지지 않고, 언제 응답이 올지도 모름

비동기를 이해하기 위해서는 **이벤트 루프** 라는 개념의 이해가 필요

# 이벤트 루프

> 자바스크립트 **런타임 외부**에서 자바스크립트 비동기 실행을 위해 만들어진 장치

## 호출 스택 CallStack

> 자바스크립트에서 수행할 코드나 함수를 순차적으로 담아두는 스택

```jsx
function bar() {
  console.log('bar');
}

function baz() {
  console.log('baz');
}

function foo() {
  console.log('foo');
  bar();
  baz();
}

foo();
```

1. `foo()` 가 호출 스택에 들어간다
2. `console.log(’foo’)` 가 호출 스택에 들어간다
3. 2 가 실행된다
4. `bar()` 가 호출 스택에 들어간다
5. `console.log(’bar’)` 가 호출 스택에 들어간다
6. 5가 실행된다
7. `bar()` 에 남은 것이 없으니 호출 스택에서 제거된다
8. `baz()` 가 호출 스택에 들어간다
9. `console.log(’baz’)` 가 호출 스택에 들어간다
10. 9가 실행된다
11. `baz()` 가 호출 스택에서 제거된다
12. `foo()` 가 호출 스택에서 제거된다
13. 호출 스택이 빈 상태가 된다

그리고 이 호출 스택이 비어있는지 확인하는 것이 **이벤트 루프** 이다

이벤트 루프의 단일 스레드에서

- 호출 스택 내부에 수행해야할 작업이 있는지 확인
- 수행해야할 코드가 있다면 자바스크립트 엔진을 이용해 수행

위 두 작업은 하나의 스레드에서 일어나서 순차적으로 실행됨

### 비동기 처리의 과정

```jsx
function bar() {
  console.log('bar');
}

function baz() {
  console.log('baz');
}

function foo() {
  console.log('foo');
  setTimeout((bar(), 0);
  baz();
}

foo();
```

해당 코드의 경우

- 동일하게 `setTimeout((bar(), 0)` 이 호출 스택에 들어가나, 타이머 이벤트가 실행되며 **태스크 큐** 로 들어가고 호출 스택에서는 바로 제거된다.
- 이후 같은 흐름으로 모든 코드가 실행되고, 호출 스택이 빈 상태가 된다.
- 이벤트 루프가 호출 스택이 빈 것을 확인한다. 그러나 태스크 큐에 `setTimeout((bar(), 0)` 이 존재하여
  `bar()` 를 호출 스택에 삽입한다.
- `bar()` 가 동작한 이후 제거되어 호출 스택이 다시 빈 상태가 된다.

## 태스크 큐

> 실행해야 할 태스크의 집합

- 이벤트 루프는 태스크 큐를 한 개 이상 가지고 있음
- 큐가 아닌 set 형태를 띄고 있음
- 실행해야할 태스크 란 비동기 함수의 콜백 함수, 이벤트 핸들러 등을 의미

이제 이벤트 루프의 역할은

1. **호출 스택이 비어있는지 확인**
2. **태스크 큐에 대기중인 함수가 있는지 확인**

위 두 동작을 반복하며 코드를 실행

---

비동기 함수의 실행, setTimeout 요청, fetch 기반 네트워크 통신을 처리하는 주체는?

⇒ 자바스크립트 코드가 동기적으로 실행되는 메인 스레드가 아닌 **태스크 큐가 할당되는 별도의 스레드**에서 수행

- 별도의 스레드에서 태스크 큐에 작업을 할당해 처리하는 것은 브라우저나 Node.js 의 역할
- 외부 Web API 등은 자바스크립트 코드 외부에서 실행되며 콜백이 태스크 큐로 들어가는 것

# 태스크 큐와 마이크로 태스크 큐

## 마이크로 태스크 큐

- 이벤트 루프는 하나의 마이크로 태스크 큐를 가짐
- 기존 태스크 큐와 다른 태스크 처리
  - 대표적으로 Promise
- 기존 태크스 큐보다 우선권 가짐
  - 마이크로 태스크 큐가 빌 때까지 기존 태스크 큐의 수행은 미뤄짐

### 렌더링 실행 시점

- 마이크로 태스크 큐 → 렌더링 발생
- 각 마이크로 태스크 큐 작업이 끝날 때마다 한 번씩 렌더링 기회를 가짐
- 브라우저의 렌더링하는 작업은 마이크로 태스크 큐와 태스크 큐 사이에서 발생
